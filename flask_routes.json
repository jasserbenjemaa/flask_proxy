{
    "/users": {
        "POST": "def create_user():\n    time.sleep(4)\n    try:\n        data = request.get_json()\n        \n        if not data or 'name' not in data or 'email' not in data:\n            return jsonify({'error': 'Name and email are required'}), 400\n        \n        # Prepare user data\n        user_data = {\n            'id': str(uuid.uuid4()),\n            'name': data['name'],\n            'email': data['email'],\n            'age': data.get('age'),\n            'created_at': datetime.now().isoformat(),\n            'updated_at': datetime.now().isoformat()\n        }\n        \n        # Insert into Supabase\n        response = supabase.table(USERS_TABLE).insert(user_data).execute()\n        result = handle_supabase_response(response)\n        \n        return jsonify(result[0] if result else user_data), 201\n    \n    except Exception as e:\n        error_msg = str(e)\n        # Handle unique constraint violation (duplicate email)\n        if 'duplicate key value' in error_msg or 'unique constraint' in error_msg:\n            return jsonify({'error': 'Email already exists'}), 409\n        return jsonify({'error': error_msg}), 500",
        "GET": "def get_all_users():\n    try:\n        # Optional query parameters for pagination and filtering\n        limit = request.args.get('limit', 100, type=int)\n        offset = request.args.get('offset', 0, type=int)\n        \n        query = supabase.table(USERS_TABLE).select(\"*\")\n        \n        # Add pagination\n        if limit:\n            query = query.limit(limit)\n        if offset:\n            query = query.offset(offset)\n        \n        # Execute query\n        response = query.execute()\n        result = handle_supabase_response(response)\n        \n        return jsonify(result), 200\n    \n    except Exception as e:\n        return jsonify({'error': str(e)}), 500"
    },
    "/users/<user_id>": {
        "GET": "def get_user(user_id):\n    try:\n        response = supabase.table(USERS_TABLE).select(\"*\").eq('id', user_id).execute()\n        result = handle_supabase_response(response)\n        \n        if not result:\n            return jsonify({'error': 'User not found'}), 404\n        \n        return jsonify(result[0]), 200\n    \n    except Exception as e:\n        return jsonify({'error': str(e)}), 500",
        "PUT": "def update_user(user_id):\n    try:\n        data = request.get_json()\n        if not data:\n            return jsonify({'error': 'No data provided'}), 400\n        \n        # Check if user exists\n        check_response = supabase.table(USERS_TABLE).select(\"*\").eq('id', user_id).execute()\n        check_result = handle_supabase_response(check_response)\n        \n        if not check_result:\n            return jsonify({'error': 'User not found'}), 404\n        \n        # Prepare update data\n        update_data = {\n            'updated_at': datetime.now().isoformat()\n        }\n        \n        # Update provided fields\n        if 'name' in data:\n            update_data['name'] = data['name']\n        if 'email' in data:\n            update_data['email'] = data['email']\n        if 'age' in data:\n            update_data['age'] = data['age']\n        \n        # Update in Supabase\n        response = supabase.table(USERS_TABLE).update(update_data).eq('id', user_id).execute()\n        result = handle_supabase_response(response)\n        \n        if not result:\n            return jsonify({'error': 'Update failed'}), 500\n        \n        return jsonify(result[0]), 200\n    \n    except Exception as e:\n        error_msg = str(e)\n        if 'duplicate key value' in error_msg or 'unique constraint' in error_msg:\n            return jsonify({'error': 'Email already exists'}), 409\n        return jsonify({'error': error_msg}), 500",
        "PATCH": "def patch_user(user_id):\n    try:\n        data = request.get_json()\n        if not data:\n            return jsonify({'error': 'No data provided'}), 400\n        \n        # Check if user exists\n        check_response = supabase.table(USERS_TABLE).select(\"*\").eq('id', user_id).execute()\n        check_result = handle_supabase_response(check_response)\n        \n        if not check_result:\n            return jsonify({'error': 'User not found'}), 404\n        \n        # Prepare update data with only provided fields\n        update_data = {'updated_at': datetime.now().isoformat()}\n        \n        for field in ['name', 'email', 'age']:\n            if field in data:\n                update_data[field] = data[field]\n        \n        # Update in Supabase\n        response = supabase.table(USERS_TABLE).update(update_data).eq('id', user_id).execute()\n        result = handle_supabase_response(response)\n        \n        if not result:\n            return jsonify({'error': 'Update failed'}), 500\n        \n        return jsonify(result[0]), 200\n    \n    except Exception as e:\n        error_msg = str(e)\n        if 'duplicate key value' in error_msg or 'unique constraint' in error_msg:\n            return jsonify({'error': 'Email already exists'}), 409\n        return jsonify({'error': error_msg}), 500",
        "DELETE": "def delete_user(user_id):\n    time.sleep(4)\n    try:\n        # Get user before deletion\n        check_response = supabase.table(USERS_TABLE).select(\"*\").eq('id', user_id).execute()\n        check_result = handle_supabase_response(check_response)\n        \n        if not check_result:\n            return jsonify({'error': 'User not found'}), 404\n        \n        deleted_user = check_result[0]\n        \n        # Delete from Supabase\n        response = supabase.table(USERS_TABLE).delete().eq('id', user_id).execute()\n        handle_supabase_response(response)\n        \n        return jsonify({\n            'message': 'User deleted successfully',\n            'deleted_user': deleted_user\n        }), 200\n    \n    except Exception as e:\n        return jsonify({'error': str(e)}), 500"
    },
    "/users/search": {
        "GET": "def search_users():\n    try:\n        email = request.args.get('email')\n        name = request.args.get('name')\n        \n        if not email and not name:\n            return jsonify({'error': 'Email or name parameter required'}), 400\n        \n        query = supabase.table(USERS_TABLE).select(\"*\")\n        \n        if email:\n            query = query.ilike('email', f'%{email}%')\n        if name:\n            query = query.ilike('name', f'%{name}%')\n        \n        response = query.execute()\n        result = handle_supabase_response(response)\n        \n        return jsonify(result), 200\n    \n    except Exception as e:\n        return jsonify({'error': str(e)}), 500"
    },
    "/health": {
        "GET": "def health_check():\n    try:\n        # Test connection by counting users\n        response = supabase.table(USERS_TABLE).select(\"*\", count=\"exact\").execute()\n        count = response.count if hasattr(response, 'count') else 0\n        \n        return jsonify({\n            'status': 'healthy',\n            'database': 'connected',\n            'total_users': count,\n            'timestamp': datetime.now().isoformat()\n        }), 200\n    \n    except Exception as e:\n        return jsonify({\n            'status': 'unhealthy',\n            'database': 'disconnected',\n            'error': str(e),\n            'timestamp': datetime.now().isoformat()\n        }), 503"
    },
    "/users/bulk": {
        "POST": "def create_bulk_users():\n    try:\n        data = request.get_json()\n        \n        if not data or 'users' not in data or not isinstance(data['users'], list):\n            return jsonify({'error': 'Users array is required'}), 400\n        \n        users_data = []\n        for user in data['users']:\n            if 'name' not in user or 'email' not in user:\n                return jsonify({'error': 'Each user must have name and email'}), 400\n            \n            user_data = {\n                'id': str(uuid.uuid4()),\n                'name': user['name'],\n                'email': user['email'],\n                'age': user.get('age'),\n                'created_at': datetime.now().isoformat(),\n                'updated_at': datetime.now().isoformat()\n            }\n            users_data.append(user_data)\n        \n        # Insert bulk data\n        response = supabase.table(USERS_TABLE).insert(users_data).execute()\n        result = handle_supabase_response(response)\n        \n        return jsonify({\n            'message': f'{len(result)} users created successfully',\n            'users': result\n        }), 201\n    \n    except Exception as e:\n        error_msg = str(e)\n        if 'duplicate key value' in error_msg or 'unique constraint' in error_msg:\n            return jsonify({'error': 'One or more emails already exist'}), 409\n        return jsonify({'error': error_msg}), 500"
    }
}